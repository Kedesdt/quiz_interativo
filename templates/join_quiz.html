<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar no Quiz - Quiz.io</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        #nameEntry {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .name-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .name-card h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .name-card input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            margin: 20px 0;
        }

        .name-card input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #gameArea {
            display: none;
            height: 100vh;
            padding: 20px;
        }

        .game-header {
            background: white;
            padding: 15px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quiz-title {
            font-size: 1.5em;
            color: #667eea;
            font-weight: 700;
        }

        .timer {
            font-size: 2em;
            font-weight: 700;
            color: #dc3545;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: calc(100% - 100px);
        }

        .question-area {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .question-text {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        /* Sala de espera dos jogadores */
        .waiting-room {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 120px;
            position: relative;
        }

        .waiting-room::before {
            content: 'üè† Sala de Espera';
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 1em;
            font-weight: 600;
            color: #667eea;
        }

        .players-waiting {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            padding-top: 20px;
        }

        /* Container da √°rea de jogo com rua vertical */
        .game-play-area {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            gap: 0;
            flex: 1;
            position: relative;
        }

        /* Colunas de respostas */
        .answers-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        /* Rua vertical no meio */
        .vertical-road {
            background: linear-gradient(90deg, #555 0%, #666 50%, #555 100%);
            position: relative;
            overflow: visible;
        }

        .road-lines-vertical {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                180deg,
                #fff 0px,
                #fff 30px,
                transparent 30px,
                transparent 60px
            );
            transform: translateX(-50%);
        }

        /* Bifurca√ß√µes da rua para as respostas */
        .road-branch {
            position: absolute;
            height: 60px;
            background: linear-gradient(90deg, #666, #555);
            z-index: 1;
        }

        .road-branch.left {
            left: -80px;
            width: 80px;
            border-radius: 0 0 0 10px;
        }

        .road-branch.right {
            right: -80px;
            width: 80px;
            border-radius: 0 0 10px 0;
        }

        .road-branch-line {
            position: absolute;
            height: 4px;
            background: repeating-linear-gradient(
                90deg,
                #fff 0px,
                #fff 20px,
                transparent 20px,
                transparent 40px
            );
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
        }

        .road-decoration {
            position: absolute;
            font-size: 1.5em;
            animation: sway 3s ease-in-out infinite;
        }

        .road-decoration:nth-child(2) {
            top: 10%;
            left: 5px;
        }

        .road-decoration:nth-child(3) {
            top: 40%;
            right: 5px;
            animation-delay: 1s;
        }

        .road-decoration:nth-child(4) {
            top: 70%;
            left: 5px;
            animation-delay: 2s;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-5deg) scale(1); }
            50% { transform: rotate(5deg) scale(1.1); }
        }

        .answer-zone {
            background: white;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: 150px;
        }

        .answer-zone:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .answer-zone.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .answer-zone.disabled:hover {
            transform: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .answer-label {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .answer-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 20px;
        }

        .players-in-zone {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: flex-start;
            min-height: 60px;
            flex: 1;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            font-size: 1.2em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .player-avatar.in-waiting-room {
            width: 60px;
            height: 60px;
            font-size: 1.5em;
        }

        .player-avatar.traveling {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
        }

        .player-avatar::after {
            content: attr(data-name);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .player-avatar:hover::after {
            opacity: 1;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .player-avatar.bounce {
            animation: bounce 0.5s ease;
        }

        @keyframes idle-bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            50% {
                transform: translateY(-8px) scale(1.05);
            }
        }

        @keyframes idle-wiggle {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-5deg) scale(1.05);
            }
            75% {
                transform: rotate(5deg) scale(1.05);
            }
        }

        @keyframes idle-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            }
        }

        @keyframes idle-sway {
            0%, 100% {
                transform: translateX(0) rotate(0deg);
            }
            50% {
                transform: translateX(5px) rotate(3deg);
            }
        }

        .player-avatar.idle-animation {
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
        }

        .waiting-message {
            background: white;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .waiting-message h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .waiting-message p {
            color: #666;
            font-size: 1.2em;
        }

        .correct-answer {
            border-color: #28a745 !important;
            background: #d4edda !important;
        }

        .wrong-answer {
            border-color: #dc3545 !important;
            background: #f8d7da !important;
        }

        .results-screen {
            background: white;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-screen h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div id="nameEntry">
        <div class="name-card">
            <h1>üéÆ Quiz.io</h1>
            <p style="color: #666; margin-bottom: 20px;">C√≥digo: <strong id="quizCodeDisplay"></strong></p>
            <input type="text" id="playerName" placeholder="Digite seu nome" maxlength="20">
            <button class="btn" onclick="joinGame()">Entrar no Jogo</button>
        </div>
    </div>

    <div id="gameArea">
        <div class="game-header">
            <div class="quiz-title" id="quizTitle">Carregando...</div>
            <div class="timer" id="timer">--</div>
        </div>

        <div id="waitingArea" class="waiting-message">
            <h2>‚è≥ Aguardando o in√≠cio...</h2>
            <p>O quiz come√ßar√° em breve!</p>
        </div>

        <div id="gameContainer" class="game-container" style="display: none;">
            <div class="question-area">
                <div class="question-text" id="questionText"></div>
            </div>
            
            <div class="waiting-room">
                <div class="players-waiting" id="playersWaiting"></div>
            </div>

            <div class="game-play-area">
                <div class="answers-column" id="leftColumn"></div>
                
                <div class="vertical-road">
                    <div class="road-lines-vertical"></div>
                    <div class="road-decoration">üå≥</div>
                    <div class="road-decoration">üå≥</div>
                    <div class="road-decoration">üå≥</div>
                </div>
                
                <div class="answers-column" id="rightColumn"></div>
            </div>
        </div>

        <div id="resultsArea" style="display: none;" class="results-screen">
            <h2>üéâ Quiz Finalizado!</h2>
            <p style="font-size: 1.3em; color: #666;">Obrigado por participar!</p>
        </div>
    </div>

    <script>
        const quizCode = window.location.pathname.split('/').pop();
        document.getElementById('quizCodeDisplay').textContent = quizCode;

        let socket;
        let currentPlayerId;
        let quizData;
        let currentQuestionIndex = 0;
        let players = new Map();
        let timerInterval;
        let canSelectAnswer = true;

        async function joinGame() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Por favor, digite seu nome!');
                return;
            }

            // Conectar ao WebSocket
            socket = io();

            socket.on('connect', () => {
                socket.emit('join_game', {
                    quiz_code: quizCode,
                    player_name: playerName
                });
            });

            socket.on('players_list', (data) => {
                data.players.forEach(player => {
                    players.set(player.id, player);
                });
                currentPlayerId = data.players[data.players.length - 1].id;
            });

            socket.on('quiz_state', (data) => {
                // Quiz j√° come√ßou - carregar estado atual
                if (data.is_active && data.current_question_index >= 0) {
                    currentQuestionIndex = data.current_question_index;
                    document.getElementById('nameEntry').style.display = 'none';
                    document.getElementById('gameArea').style.display = 'block';
                    document.getElementById('waitingArea').style.display = 'none';
                    document.getElementById('gameContainer').style.display = 'flex';
                    initializePlayersInWaitingRoom();
                    loadQuestion(currentQuestionIndex);
                    
                    // Carregar respostas atuais dos jogadores ap√≥s um delay
                    if (data.player_answers) {
                        setTimeout(() => {
                            Object.keys(data.player_answers).forEach(pid => {
                                const answerId = data.player_answers[pid];
                                const player = players.get(parseInt(pid));
                                if (player && answerId) {
                                    movePlayerToAnswerInstant(parseInt(pid), answerId, player.name, player.color);
                                }
                            });
                        }, 500);
                    }
                }
            });

            socket.on('quiz_state', (data) => {
                // Quiz j√° come√ßou - carregar estado atual
                if (data.is_active && data.current_question_index >= 0) {
                    currentQuestionIndex = data.current_question_index;
                    document.getElementById('nameEntry').style.display = 'none';
                    document.getElementById('gameArea').style.display = 'block';
                    document.getElementById('waitingArea').style.display = 'none';
                    document.getElementById('gameContainer').style.display = 'flex';
                    initializePlayersInWaitingRoom();
                    loadQuestion(currentQuestionIndex);
                }
            });

            socket.on('player_joined', (data) => {
                players.set(data.player_id, data);
            });

            socket.on('player_left', (data) => {
                players.delete(data.player_id);
                updatePlayerPositions();
            });

            socket.on('quiz_started', (data) => {
                startQuiz();
            });

            socket.on('question_changed', (data) => {
                currentQuestionIndex = data.question_index;
                loadQuestion(currentQuestionIndex);
            });

            socket.on('answer_selected', (data) => {
                movePlayerToAnswer(data.player_id, data.answer_id, data.player_name, data.player_color);
            });

            socket.on('quiz_ended', () => {
                showResults();
            });

            // Carregar dados do quiz
            const response = await fetch(`/api/quiz/${quizCode}`);
            quizData = await response.json();
            document.getElementById('quizTitle').textContent = quizData.title;

            document.getElementById('nameEntry').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
        }

        function startQuiz() {
            document.getElementById('waitingArea').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            loadQuestion(0);
            initializePlayersInWaitingRoom();
        }

        function initializePlayersInWaitingRoom() {
            const waitingRoom = document.getElementById('playersWaiting');
            waitingRoom.innerHTML = '';
            
            const animations = ['idle-bounce', 'idle-wiggle', 'idle-pulse', 'idle-sway'];
            
            players.forEach((player, playerId) => {
                const avatar = document.createElement('div');
                avatar.className = 'player-avatar in-waiting-room idle-animation';
                avatar.style.backgroundColor = player.color;
                avatar.textContent = player.name.charAt(0).toUpperCase();
                avatar.setAttribute('data-player-id', playerId);
                avatar.setAttribute('data-name', player.name);
                avatar.id = `player-${playerId}`;
                
                // Escolher anima√ß√£o aleat√≥ria
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                avatar.style.animationName = randomAnimation;
                
                // Delay aleat√≥rio para n√£o sincronizar
                avatar.style.animationDelay = (Math.random() * 1.5) + 's';
                
                waitingRoom.appendChild(avatar);
            });
        }

        function loadQuestion(index) {
            if (index >= quizData.questions.length) {
                showResults();
                return;
            }

            const question = quizData.questions[index];
            document.getElementById('questionText').textContent = question.text;

            const leftColumn = document.getElementById('leftColumn');
            const rightColumn = document.getElementById('rightColumn');
            const road = document.querySelector('.vertical-road');
            
            leftColumn.innerHTML = '';
            rightColumn.innerHTML = '';
            
            // Remover bifurca√ß√µes antigas
            document.querySelectorAll('.road-branch').forEach(el => el.remove());
            
            canSelectAnswer = true;

            question.answers.forEach((answer, idx) => {
                const zone = document.createElement('div');
                zone.className = 'answer-zone';
                zone.onclick = () => selectAnswer(answer.id);
                zone.setAttribute('data-answer-id', answer.id);
                zone.setAttribute('data-answer-index', idx);

                zone.innerHTML = `
                    <div class="answer-label">${String.fromCharCode(65 + idx)}</div>
                    <div class="answer-text">${answer.text}</div>
                    <div class="players-in-zone" id="zone-${answer.id}"></div>
                `;

                // Distribuir respostas: pares √† esquerda, √≠mpares √† direita
                if (idx % 2 === 0) {
                    leftColumn.appendChild(zone);
                } else {
                    rightColumn.appendChild(zone);
                }
            });

            // Criar bifurca√ß√µes da rua para cada resposta ap√≥s renderiza√ß√£o
            setTimeout(() => {
                question.answers.forEach((answer, idx) => {
                    const zone = document.querySelector(`[data-answer-id="${answer.id}"]`);
                    if (!zone) return;

                    const zoneRect = zone.getBoundingClientRect();
                    const roadRect = road.getBoundingClientRect();
                    
                    const branch = document.createElement('div');
                    branch.className = `road-branch ${idx % 2 === 0 ? 'left' : 'right'}`;
                    branch.setAttribute('data-answer-id', answer.id);
                    
                    // Posicionar bifurca√ß√£o no topo da zona de resposta
                    const topPosition = zoneRect.top - roadRect.top;
                    branch.style.top = topPosition + 'px';
                    
                    branch.innerHTML = '<div class="road-branch-line"></div>';
                    
                    road.appendChild(branch);
                });
            }, 50);

            // Retornar todos os jogadores para a sala de espera
            returnAllPlayersToWaitingRoom();

            startTimer(quizData.time_limit);
        }

        function returnAllPlayersToWaitingRoom() {
            const waitingRoom = document.getElementById('playersWaiting');
            
            // Remover avatares das zonas de resposta
            document.querySelectorAll('.answer-zone .player-avatar').forEach(el => el.remove());
            
            // Recriar todos na sala de espera com anima√ß√µes
            const animations = ['idle-bounce', 'idle-wiggle', 'idle-pulse', 'idle-sway'];
            
            waitingRoom.innerHTML = '';
            players.forEach((player, playerId) => {
                const avatar = document.createElement('div');
                avatar.className = 'player-avatar in-waiting-room idle-animation';
                avatar.style.backgroundColor = player.color;
                avatar.textContent = player.name.charAt(0).toUpperCase();
                avatar.setAttribute('data-player-id', playerId);
                avatar.setAttribute('data-name', player.name);
                avatar.id = `player-${playerId}`;
                
                // Escolher anima√ß√£o aleat√≥ria
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                avatar.style.animationName = randomAnimation;
                
                // Delay aleat√≥rio
                avatar.style.animationDelay = (Math.random() * 1.5) + 's';
                
                waitingRoom.appendChild(avatar);
            });
        }

        function selectAnswer(answerId) {
            if (!canSelectAnswer) {
                return; // N√£o permitir mudan√ßa ap√≥s tempo acabar
            }
            
            socket.emit('select_answer', {
                player_id: currentPlayerId,
                question_id: quizData.questions[currentQuestionIndex].id,
                answer_id: answerId,
                quiz_code: quizCode
            });
        }

        function movePlayerToAnswerInstant(playerId, answerId, playerName, playerColor) {
            // Vers√£o instant√¢nea sem anima√ß√£o para carregar estado atual
            const player = players.get(playerId);
            if (!player) return;
            if (!answerId) return;

            // Remover da sala de espera
            const waitingAvatar = document.querySelector(`.players-waiting .player-avatar[data-player-id="${playerId}"]`);
            if (waitingAvatar) waitingAvatar.remove();

            // Adicionar diretamente na zona de resposta
            const animations = ['idle-bounce', 'idle-wiggle', 'idle-pulse', 'idle-sway'];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            
            const finalAvatar = document.createElement('div');
            finalAvatar.className = 'player-avatar idle-animation';
            finalAvatar.style.backgroundColor = playerColor || player.color;
            finalAvatar.textContent = (playerName || player.name).charAt(0).toUpperCase();
            finalAvatar.setAttribute('data-player-id', playerId);
            finalAvatar.setAttribute('data-name', playerName || player.name);
            finalAvatar.style.animationName = randomAnimation;
            finalAvatar.style.animationDelay = (Math.random() * 1.5) + 's';
            
            const playersZone = document.getElementById(`zone-${answerId}`);
            if (playersZone) {
                playersZone.appendChild(finalAvatar);
            }
        }

        function movePlayerToAnswer(playerId, answerId, playerName, playerColor) {
            const player = players.get(playerId);
            if (!player) return;

            if (!answerId) return;

            // Verificar se o jogador j√° est√° em alguma resposta
            const existingInZone = document.querySelector(`.players-in-zone .player-avatar[data-player-id="${playerId}"]`);
            let startX, startY;

            // Criar avatar de viagem
            const tempAvatar = document.createElement('div');
            tempAvatar.className = 'player-avatar traveling';
            tempAvatar.style.backgroundColor = playerColor || player.color;
            tempAvatar.textContent = (playerName || player.name).charAt(0).toUpperCase();
            tempAvatar.setAttribute('data-player-id', playerId + '-temp');
            tempAvatar.style.width = '50px';
            tempAvatar.style.height = '50px';

            if (existingInZone) {
                // Jogador est√° mudando de resposta - come√ßar de onde ele est√°
                const existingRect = existingInZone.getBoundingClientRect();
                startX = existingRect.left;
                startY = existingRect.top;
                existingInZone.remove();
            } else {
                // Primeira resposta - come√ßar da sala de espera
                const waitingAvatar = document.querySelector(`.players-waiting .player-avatar[data-player-id="${playerId}"]`);
                if (waitingAvatar) {
                    const waitingRect = waitingAvatar.getBoundingClientRect();
                    startX = waitingRect.left;
                    startY = waitingRect.top;
                    waitingAvatar.remove();
                } else {
                    const waitingRoom = document.getElementById('playersWaiting');
                    const waitingRect = waitingRoom.getBoundingClientRect();
                    startX = waitingRect.left + waitingRect.width / 2 - 25;
                    startY = waitingRect.top + waitingRect.height / 2 - 25;
                }
            }

            // Remover qualquer outro avatar duplicado
            const allOldAvatars = document.querySelectorAll(`[data-player-id="${playerId}"]`);
            allOldAvatars.forEach(el => el.remove());

            tempAvatar.style.left = startX + 'px';
            tempAvatar.style.top = startY + 'px';
            
            document.body.appendChild(tempAvatar);

            // Calcular caminho com bifurca√ß√£o
            const zone = document.querySelector(`[data-answer-id="${answerId}"]`);
            if (!zone) {
                tempAvatar.remove();
                return;
            }

            const zoneRect = zone.getBoundingClientRect();
            const road = document.querySelector('.vertical-road');
            const roadRect = road.getBoundingClientRect();
            const branch = document.querySelector(`.road-branch[data-answer-id="${answerId}"]`);
            
            // Determinar se √© resposta da esquerda ou direita
            const answerIndex = parseInt(zone.getAttribute('data-answer-index'));
            const isLeft = answerIndex % 2 === 0;
            
            // Posi√ß√£o final (topo da zona de resposta)
            const finalX = zoneRect.left + zoneRect.width / 2 - 25;
            const finalY = zoneRect.top - 30; // Acima da zona
            
            // Posi√ß√µes da rua
            const roadCenterX = roadRect.left + roadRect.width / 2 - 25;
            const roadMidY = (startY + zoneRect.top) / 2;
            
            // Ponto da bifurca√ß√£o
            const branchY = zoneRect.top;
            const branchX = isLeft ? roadCenterX - 40 : roadCenterX + 40;

            // Animar em 4 etapas: Origem -> Rua central -> Bifurca√ß√£o -> Resposta
            setTimeout(() => {
                // Etapa 1: Ir para a rua central
                tempAvatar.style.transition = 'all 0.5s ease-in-out';
                tempAvatar.style.left = roadCenterX + 'px';
                tempAvatar.style.top = roadMidY + 'px';
                tempAvatar.style.transform = 'rotate(90deg) scale(1.2)';
            }, 50);

            setTimeout(() => {
                // Etapa 2: Descer pela rua at√© a altura da bifurca√ß√£o
                tempAvatar.style.transition = 'all 0.7s ease-in-out';
                tempAvatar.style.top = branchY + 'px';
                tempAvatar.style.transform = 'rotate(180deg) scale(1.3)';
            }, 600);

            setTimeout(() => {
                // Etapa 3: Entrar na bifurca√ß√£o (esquerda ou direita)
                tempAvatar.style.transition = 'all 0.5s ease-in-out';
                tempAvatar.style.left = branchX + 'px';
                tempAvatar.style.transform = `rotate(${isLeft ? 270 : 90}deg) scale(1.2)`;
            }, 1350);

            setTimeout(() => {
                // Etapa 4: Ir at√© a resposta
                tempAvatar.style.transition = 'all 0.6s ease-out';
                tempAvatar.style.left = finalX + 'px';
                tempAvatar.style.top = finalY + 'px';
                tempAvatar.style.transform = 'rotate(360deg) scale(1)';
            }, 1900);

            // Finalizar: adicionar avatar fixo na zona
            setTimeout(() => {
                tempAvatar.remove();
                
                const animations = ['idle-bounce', 'idle-wiggle', 'idle-pulse', 'idle-sway'];
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                
                const finalAvatar = document.createElement('div');
                finalAvatar.className = 'player-avatar bounce idle-animation';
                finalAvatar.style.backgroundColor = playerColor || player.color;
                finalAvatar.textContent = (playerName || player.name).charAt(0).toUpperCase();
                finalAvatar.setAttribute('data-player-id', playerId);
                finalAvatar.setAttribute('data-name', playerName || player.name);
                finalAvatar.style.animationName = randomAnimation;
                finalAvatar.style.animationDelay = (Math.random() * 1.5) + 's';
                
                const playersZone = document.getElementById(`zone-${answerId}`);
                if (playersZone) {
                    playersZone.appendChild(finalAvatar);
                    
                    setTimeout(() => {
                        finalAvatar.classList.remove('bounce');
                    }, 500);
                }
            }, 2550);
        }

        function updatePlayerPositions() {
            // Atualizar visualiza√ß√£o de todos os jogadores
            players.forEach((player, playerId) => {
                const avatars = document.querySelectorAll(`.player-avatar[data-player-id="${playerId}"]`);
                avatars.forEach(avatar => {
                    avatar.style.backgroundColor = player.color;
                });
            });
        }

        function movePlayerToAnswerInstant(playerId, answerId, playerName, playerColor) {
            // Vers√£o instant√¢nea sem anima√ß√£o para carregar estado atual
            const player = players.get(playerId);
            if (!player) return;
            if (!answerId) return;

            // Remover da sala de espera
            const waitingAvatar = document.querySelector(`.players-waiting .player-avatar[data-player-id="${playerId}"]`);
            if (waitingAvatar) waitingAvatar.remove();

            // Adicionar diretamente na zona de resposta
            const animations = ['idle-bounce', 'idle-wiggle', 'idle-pulse', 'idle-sway'];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            
            const finalAvatar = document.createElement('div');
            finalAvatar.className = 'player-avatar idle-animation';
            finalAvatar.style.backgroundColor = playerColor || player.color;
            finalAvatar.textContent = (playerName || player.name).charAt(0).toUpperCase();
            finalAvatar.setAttribute('data-player-id', playerId);
            finalAvatar.setAttribute('data-name', playerName || player.name);
            finalAvatar.style.animationName = randomAnimation;
            finalAvatar.style.animationDelay = (Math.random() * 1.5) + 's';
            
            const playersZone = document.getElementById(`zone-${answerId}`);
            if (playersZone) {
                playersZone.appendChild(finalAvatar);
            }
        }

        function startTimer(seconds) {
            if (timerInterval) clearInterval(timerInterval);

            let timeLeft = seconds;
            const timerEl = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                timerEl.textContent = timeLeft;
                
                if (timeLeft <= 10) {
                    timerEl.style.color = '#dc3545';
                } else {
                    timerEl.style.color = '#28a745';
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    canSelectAnswer = false; // Bloquear sele√ß√£o
                    // Desabilitar visualmente as zonas de resposta
                    document.querySelectorAll('.answer-zone').forEach(zone => {
                        zone.classList.add('disabled');
                    });
                    timerEl.textContent = 'Tempo Esgotado!';
                    timerEl.style.color = '#dc3545';
                }

                timeLeft--;
            }, 1000);
        }

        function showResults() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'block';
        }
    </script>
</body>
</html>

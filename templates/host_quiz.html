<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Quiz - Quiz.io</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 40px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .quiz-info h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .quiz-code {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .sidebar h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .players-list {
            list-style: none;
        }

        .player-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .game-area {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .lobby-screen, .question-screen, .results-screen {
            text-align: center;
        }

        .lobby-screen h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .lobby-screen p {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-3px);
        }

        .question-display {
            margin-bottom: 40px;
        }

        .question-number {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 2em;
            color: #333;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .timer-display {
            font-size: 3em;
            font-weight: 700;
            color: #28a745;
            margin: 30px 0;
        }

        .timer-display.warning {
            color: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .answers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .answer-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 3px solid transparent;
        }

        .answer-card.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .answer-label {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .answer-text {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 15px;
            text-align: left;
        }

        .answer-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }

        .player-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
        }

        .player-avatar-small::after {
            content: attr(data-name);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .player-avatar-small:hover::after {
            opacity: 1;
        }

        .results-screen h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="quiz-info">
                <h1 id="quizTitle">{{ quiz.title }}</h1>
                <p style="color: #666;">Tempo por pergunta: <strong>{{ quiz.time_limit }}s</strong></p>
            </div>
            <div class="quiz-code">{{ code }}</div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h2>üë• Jogadores (<span id="playerCount">0</span>)</h2>
                <ul class="players-list" id="playersList"></ul>
            </div>

            <div class="game-area">
                <div id="lobbyScreen" class="lobby-screen">
                    <h2>üéÆ Sala de Espera</h2>
                    <p>Aguardando jogadores entrarem...</p>
                    <p style="font-size: 1em; color: #999; margin-bottom: 30px;">
                        Compartilhe o c√≥digo <strong>{{ code }}</strong> com os participantes
                    </p>
                    <button class="btn btn-primary" onclick="startQuiz()">
                        üöÄ Iniciar Quiz
                    </button>
                </div>

                <div id="questionScreen" class="question-screen" style="display: none;">
                    <div class="question-display">
                        <div class="question-number" id="questionNumber"></div>
                        <div class="question-text" id="questionText"></div>
                        <div class="timer-display" id="timer">--</div>
                    </div>
                    <div class="answers-grid" id="answersGrid"></div>
                    <button class="btn btn-success" onclick="nextQuestion()" style="margin-top: 30px;" id="nextBtn">
                        ‚û°Ô∏è Pr√≥xima Pergunta
                    </button>
                </div>

                <div id="resultsScreen" class="results-screen" style="display: none;">
                    <h2>üéâ Quiz Finalizado!</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalPlayers">0</div>
                            <div class="stat-label">Jogadores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalQuestions">0</div>
                            <div class="stat-label">Perguntas</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="window.location.href='/'" style="margin-top: 30px;">
                        üè† Voltar ao In√≠cio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const quizCode = '{{ code }}';
        let socket;
        let quizData;
        let currentQuestionIndex = 0;
        let players = new Map();
        let timerInterval;
        let playerAnswers = new Map(); // Map de question_id -> Map de player_id -> answer_id

        async function init() {
            // Conectar WebSocket
            socket = io();

            socket.on('connect', () => {
                socket.emit('join_host', {
                    quiz_code: quizCode
                });
            });

            socket.on('players_list', (data) => {
                data.players.forEach(player => {
                    players.set(player.id, player);
                });
                updatePlayersList();
            });

            socket.on('player_joined', (data) => {
                players.set(data.player_id, data);
                updatePlayersList();
            });

            socket.on('player_left', (data) => {
                players.delete(data.player_id);
                updatePlayersList();
                updateAnswersDisplay();
            });

            socket.on('answer_selected', (data) => {
                const questionId = quizData.questions[currentQuestionIndex].id;
                if (!playerAnswers.has(questionId)) {
                    playerAnswers.set(questionId, new Map());
                }
                playerAnswers.get(questionId).set(data.player_id, data.answer_id);
                updateAnswersDisplay();
            });

            // Carregar quiz
            const response = await fetch(`/api/quiz/${quizCode}?host=true`);
            quizData = await response.json();
        }

        function updatePlayersList() {
            const list = document.getElementById('playersList');
            list.innerHTML = '';

            players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'player-item';
                li.innerHTML = `
                    <div class="player-color" style="background-color: ${player.color}"></div>
                    <div class="player-name">${player.name}</div>
                `;
                list.appendChild(li);
            });

            document.getElementById('playerCount').textContent = players.size;
        }

        function startQuiz() {
            if (players.size === 0) {
                alert('Aguarde pelo menos um jogador entrar!');
                return;
            }

            socket.emit('start_quiz', {
                quiz_code: quizCode
            });

            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('questionScreen').style.display = 'block';
            
            loadQuestion(0);
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const question = quizData.questions[index];

            document.getElementById('questionNumber').textContent = `Pergunta ${index + 1} de ${quizData.questions.length}`;
            document.getElementById('questionText').textContent = question.text;

            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';

            question.answers.forEach((answer, idx) => {
                const card = document.createElement('div');
                card.className = 'answer-card';
                if (answer.is_correct) {
                    card.classList.add('correct');
                }

                card.innerHTML = `
                    <div class="answer-header">
                        <div class="answer-label">${String.fromCharCode(65 + idx)}</div>
                        ${answer.is_correct ? '<span style="color: #28a745; font-size: 1.5em;">‚úì</span>' : ''}
                    </div>
                    <div class="answer-text">${answer.text}</div>
                    <div class="answer-players" id="answer-players-${answer.id}"></div>
                `;

                answersGrid.appendChild(card);
            });

            // Limpar respostas desta pergunta
            if (!playerAnswers.has(question.id)) {
                playerAnswers.set(question.id, new Map());
            }

            startTimer(quizData.time_limit);
            updateAnswersDisplay();

            // Atualizar bot√£o
            const nextBtn = document.getElementById('nextBtn');
            if (index >= quizData.questions.length - 1) {
                nextBtn.textContent = 'üèÅ Finalizar Quiz';
            }
        }

        function updateAnswersDisplay() {
            if (!quizData || currentQuestionIndex >= quizData.questions.length) return;

            const question = quizData.questions[currentQuestionIndex];
            const answers = playerAnswers.get(question.id) || new Map();

            question.answers.forEach(answer => {
                const container = document.getElementById(`answer-players-${answer.id}`);
                if (!container) return;

                container.innerHTML = '';

                answers.forEach((selectedAnswerId, playerId) => {
                    if (selectedAnswerId === answer.id) {
                        const player = players.get(playerId);
                        if (player) {
                            const avatar = document.createElement('div');
                            avatar.className = 'player-avatar-small';
                            avatar.style.backgroundColor = player.color;
                            avatar.textContent = player.name.charAt(0).toUpperCase();
                            avatar.setAttribute('data-name', player.name);
                            container.appendChild(avatar);
                        }
                    }
                });
            });
        }

        function startTimer(seconds) {
            if (timerInterval) clearInterval(timerInterval);

            let timeLeft = seconds;
            const timerEl = document.getElementById('timer');
            
            timerInterval = setInterval(() => {
                timerEl.textContent = timeLeft + 's';
                
                if (timeLeft <= 10) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }

                timeLeft--;
            }, 1000);
        }

        function nextQuestion() {
            if (timerInterval) clearInterval(timerInterval);

            if (currentQuestionIndex < quizData.questions.length - 1) {
                socket.emit('next_question', {
                    quiz_code: quizCode
                });
                loadQuestion(currentQuestionIndex + 1);
            } else {
                endQuiz();
            }
        }

        function endQuiz() {
            if (timerInterval) clearInterval(timerInterval);

            socket.emit('quiz_ended', {
                quiz_code: quizCode
            });

            document.getElementById('questionScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';

            document.getElementById('totalPlayers').textContent = players.size;
            document.getElementById('totalQuestions').textContent = quizData.questions.length;
        }

        init();
    </script>
</body>
</html>
